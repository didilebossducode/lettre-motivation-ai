<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Lettre de Motivation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-section {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .result-section {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        #letterContent {
            min-height: 300px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 11pt;
            line-height: 1.15;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
        .template-controls {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        .formatting-controls {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        .btn-format {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            background-color: white;
            cursor: pointer;
        }
        .btn-format:hover {
            background-color: #e9ecef;
        }
        .btn-format.active {
            background-color: #0d6efd;
            color: white;
        }
        .marker-legend {
            background-color: white;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .marker-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .color-sample {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
        .marker-description {
            flex: 1;
            font-size: 0.9rem;
        }
        .marker-button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            background-color: white;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .marker-button:hover {
            background-color: #e9ecef;
        }
        .marked-text {
            padding: 2px 0;
            border-radius: 2px;
        }
        .marked-company { background-color: #34C759; }
        .marked-position { background-color: #3498DB; }
        .marked-duration { background-color: #9B59B6; }
        .marked-start_date { background-color: #F7DC6F; }
        .marked-today_date { background-color: #FFC5C5; }
        .marked-custom { background-color: #FFA07A; }
        .info-summary {
            background-color: white;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 3px;
            background-color: #f8f9fa;
        }
        .info-label {
            font-weight: bold;
            min-width: 150px;
        }
        .info-value {
            flex: 1;
            color: #495057;
        }
        .info-value.empty {
            color: #dc3545;
            font-style: italic;
        }
        .validation-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Mode sombre */
        :root {
            --bg-color: #ffffff;
            --text-color: #1D1E1E;
            --border-color: #dee2e6;
            --hover-color: #e9ecef;
            --success-color: #28a745;
            --error-color: #dc3545;
            --primary-color: #0d6efd;
        }

        [data-theme="dark"] {
            --bg-color: #1D1E1E;
            --text-color: #F9F9FA;
            --border-color: #495057;
            --hover-color: #343a40;
            --success-color: #34C759;
            --error-color: #FF3737;
            --primary-color: #3498DB;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .form-control {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .form-control:focus {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .info-summary, .marker-legend {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
        }

        .info-item {
            background-color: var(--hover-color);
        }

        /* Styles avancés pour le texte */
        .text-editor {
            position: relative;
            margin-bottom: 1rem;
        }

        .text-editor-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            padding: 0.5rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding: 0 0.5rem;
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .btn-toolbar {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2rem;
        }

        .btn-toolbar:hover {
            background-color: var(--hover-color);
        }

        .btn-toolbar.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Styles pour le texte formaté */
        .text-bold { font-weight: bold; }
        .text-italic { font-style: italic; }
        .text-underline { text-decoration: underline; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-justify { text-align: justify; }
        
        /* Bouton de thème */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            z-index: 1000;
        }

        .theme-toggle:hover {
            background-color: var(--hover-color);
        }
        
        /* Modal de prévisualisation */
        .modal.fade {
            transition: opacity 0.3s;
        }
        
        .modal.fade.show {
            opacity: 1;
        }
        
        .modal-dialog {
            max-width: 800px;
            margin: 1.75rem auto;
        }
        
        .modal-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            pointer-events: auto;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,.2);
            border-radius: 0.3rem;
            outline: 0;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            border-top-left-radius: 0.3rem;
            border-top-right-radius: 0.3rem;
        }
        
        .modal-header .btn-close {
            padding: 0.5rem 0.5rem;
            margin: -0.5rem -0.5rem -0.5rem auto;
        }
        
        .modal-title {
            margin-bottom: 0;
            line-height: 1.5;
        }
        
        .modal-body {
            position: relative;
            flex: 1 1 auto;
            padding: 1rem;
        }
        
        .modal-footer {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            padding: 0.75rem;
            border-top: 1px solid #dee2e6;
            border-bottom-right-radius: 0.3rem;
            border-bottom-left-radius: 0.3rem;
        }
        
        .modal-footer > * {
            margin: 0.25rem;
        }
        
        .preview-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .preview-button i {
            font-size: 1.2em;
        }
        
        #previewContent {
            min-height: 297mm;
            width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: white;
        }
        
        @media (max-width: 768px) {
            #previewContent {
                width: 100%;
                padding: 10mm;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #previewContent, #previewContent * {
                visibility: visible;
            }
            #previewContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 20mm;
                font-size: 11.5pt;
                line-height: 1.15;
            }
        }
    </style>
</head>
<body>
    <!-- Bouton de thème -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Changer le thème">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </button>
    <div class="language-selector">
        <select id="languageSelect" class="form-select" onchange="changeLanguage(this.value)" aria-label="Sélectionner la langue">
            <option value="fr">Français</option>
            <option value="en">English</option>
        </select>
    </div>
    <div class="main-container">
        <h1 class="text-center mb-4" aria-level="1">Générateur de Lettre de Motivation</h1>
        
        <!-- Formulaire -->
        <form id="letterForm" role="form" aria-label="Formulaire de génération de lettre">
            <section aria-labelledby="infoSection">
                <h2 id="infoSection" class="h4 mb-3">Informations</h2>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="company" class="form-label" data-i18n="company_label">Nom de l'entreprise</label>
                        <input type="text" class="form-control" id="company" required 
                               data-validate="required" 
                               aria-required="true"
                               aria-describedby="companyHelp">
                        <div id="companyHelp" class="form-text" data-i18n="company_help">
                            Entrez le nom de l'entreprise à laquelle vous postulez
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="position" class="form-label" data-i18n="position_label">Poste</label>
                        <input type="text" class="form-control" id="position" required 
                               data-validate="required"
                               aria-required="true"
                               aria-describedby="positionHelp">
                        <div id="positionHelp" class="form-text" data-i18n="position_help">
                            Entrez l'intitulé du poste pour lequel vous postulez
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="duration" class="form-label" data-i18n="duration_label">Type de contrat</label>
                        <input type="text" class="form-control" id="duration" required data-validate="duration">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="start_date" class="form-label" data-i18n="start_date_label">Date de début</label>
                        <input type="text" class="form-control" id="start_date" required data-validate="date">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="letter_template_label">Modèle de lettre</label>
                    <div class="text-editor">
                        <div class="text-editor-toolbar">
                            <div class="toolbar-group">
                                <button class="btn-toolbar" onclick="formatText('bold')" title="Gras">B</button>
                                <button class="btn-toolbar" onclick="formatText('italic')" title="Italique">I</button>
                                <button class="btn-toolbar" onclick="formatText('underline')" title="Souligné">U</button>
                            </div>
                            <div class="toolbar-group">
                                <button class="btn-toolbar" onclick="alignText('left')" title="Aligner à gauche">←</button>
                                <button class="btn-toolbar" onclick="alignText('center')" title="Centrer">↔</button>
                                <button class="btn-toolbar" onclick="alignText('right')" title="Aligner à droite">→</button>
                                <button class="btn-toolbar" onclick="alignText('justify')" title="Justifier">≡</button>
                            </div>
                            <div class="toolbar-group">
                                <select class="btn-toolbar" onchange="setLineSpacing(this.value)" title="Interligne">
                                    <option value="1">Simple</option>
                                    <option value="1.15" selected>1.15</option>
                                    <option value="1.5">1.5</option>
                                    <option value="2">Double</option>
                                </select>
                            </div>
                        </div>
                        <textarea class="form-control" id="letter_template" rows="10" placeholder="Entrez votre modèle de lettre ici..."></textarea>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="info_summary_label">Résumé des informations</label>
                    <div class="info-summary">
                        <h6 class="mb-3" data-i18n="info_summary_title">Informations qui seront utilisées pour la génération :</h6>
                        <div class="info-item">
                            <div class="info-label" data-i18n="company_label">Entreprise :</div>
                            <div class="info-value empty" id="summary-company" data-i18n="company_empty">Non renseigné</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label" data-i18n="position_label">Poste :</div>
                            <div class="info-value empty" id="summary-position" data-i18n="position_empty">Non renseigné</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label" data-i18n="duration_label">Type de contrat :</div>
                            <div class="info-value empty" id="summary-duration" data-i18n="duration_empty">Non renseigné</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label" data-i18n="start_date_label">Date de début :</div>
                            <div class="info-value empty" id="summary-start_date" data-i18n="start_date_empty">Non renseigné</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label" data-i18n="custom_paragraph_label">Paragraphe personnalisé :</div>
                            <div class="info-value empty" id="summary-custom_paragraph" data-i18n="custom_paragraph_empty">Non renseigné</div>
                        </div>
                    </div>
                    <div id="validation-errors"></div>
                </div>
                <div class="mb-3">
                    <label for="custom_paragraph" class="form-label" data-i18n="custom_paragraph_label">Paragraphe personnalisé</label>
                    <div class="template-controls">
                        <div class="d-flex align-items-center mb-2">
                            <select class="form-select me-2" id="templateSelect">
                                <option value="">Sélectionner un modèle...</option>
                            </select>
                            <button class="btn btn-primary" onclick="addTemplate()">
                                +
                            </button>
                            <button class="btn btn-secondary ms-2" onclick="editTemplate()">
                                ✎
                            </button>
                            <button class="btn btn-danger ms-2" onclick="deleteTemplate()">
                                ✕
                            </button>
                        </div>
                    </div>
                    <div class="formatting-controls">
                        <div class="btn-group">
                            <button class="btn-format" onclick="formatText('bold')" title="Gras">B</button>
                            <button class="btn-format" onclick="formatText('italic')" title="Italique">I</button>
                            <button class="btn-format" onclick="formatText('underline')" title="Souligné">U</button>
                            <div class="vr mx-2"></div>
                            <button class="btn-format" onclick="alignText('left')" title="Aligner à gauche">←</button>
                            <button class="btn-format" onclick="alignText('center')" title="Centrer">↔</button>
                            <button class="btn-format" onclick="alignText('right')" title="Aligner à droite">→</button>
                            <button class="btn-format" onclick="alignText('justify')" title="Justifier">≡</button>
                            <div class="vr mx-2"></div>
                            <select class="form-select" style="width: auto;" onchange="setLineSpacing(this.value)">
                                <option value="1.0">Simple</option>
                                <option value="1.15">1.15</option>
                                <option value="1.5">1.5</option>
                                <option value="2.0">Double</option>
                            </select>
                        </div>
                    </div>
                    <textarea class="form-control" id="custom_paragraph" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-i18n="generate_button">Générer la lettre</button>
            </section>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner-border loading-spinner text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-3" data-i18n="loading_message">Génération de la lettre en cours...</p>
            </div>

            <!-- Résultat -->
            <div class="result-section" id="resultSection" style="display: none;">
                <h3 data-i18n="result_title">Lettre générée</h3>
                <div class="text-editor">
                    <div class="text-editor-toolbar">
                        <div class="toolbar-group">
                            <button class="btn-toolbar" onclick="copyToClipboard()" title="Copier">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button class="btn-toolbar" onclick="exportLetter('docx')" title="Exporter en Word">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                                Word
                            </button>
                            <button class="btn-toolbar" onclick="exportLetter('pdf')" title="Exporter en PDF">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                                PDF
                            </button>
                        </div>
                    </div>
                    <div id="letterContent" class="form-control" style="min-height: 300px; white-space: pre-wrap;"></div>
                </div>
            </div>
        </form>
    </div>

    <!-- Modal de prévisualisation -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel" data-i18n="preview_title">Prévisualisation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContent" class="letter-content p-4" style="background-color: white;">
                        <!-- Le contenu formaté sera inséré ici -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="exportLetter('docx')" data-i18n="export_word">Exporter en Word</button>
                    <button type="button" class="btn btn-primary" onclick="exportLetter('pdf')" data-i18n="export_pdf">Exporter en PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton de prévisualisation flottant -->
    <button class="btn btn-primary preview-button" onclick="previewLetter()" data-i18n="preview_button">
        <i class="fas fa-eye"></i>
        <span>Prévisualiser</span>
    </button>

    <script>
        // Traductions
        const translations = {
            'fr': {
                'company_label': "Nom de l'entreprise",
                'company_help': "Entrez le nom de l'entreprise à laquelle vous postulez",
                'position_label': "Poste",
                'position_help': "Entrez l'intitulé du poste pour lequel vous postulez",
                'duration_label': "Type de contrat",
                'duration_help': "Exemple: '6 mois', '2 ans', '3 semaines'",
                'start_date_label': "Date de début",
                'start_date_help': "Format: JJ/MM/AAAA",
                'generate_button': "Générer la lettre",
                'clear_button': "Effacer",
                'result_title': "Lettre générée",
                'copy_success': "Lettre copiée dans le presse-papiers !",
                'export_word': "Exporter en Word",
                'export_pdf': "Exporter en PDF",
                'new_template': "Nouveau modèle",
                'template_name': "Nom du modèle",
                'template_category': "Catégorie",
                'template_tags': "Tags (séparés par des virgules)",
                'template_content': "Contenu",
                'save': "Enregistrer",
                'cancel': "Annuler",
                'delete_confirm': "Voulez-vous vraiment supprimer ce modèle ?"
            },
            'en': {
                'company_label': "Company name",
                'company_help': "Enter the name of the company you are applying to",
                'position_label': "Position",
                'position_help': "Enter the job title you are applying for",
                'duration_label': "Contract type",
                'duration_help': "Example: '6 months', '2 years', '3 weeks'",
                'start_date_label': "Start date",
                'start_date_help': "Format: DD/MM/YYYY",
                'generate_button': "Generate letter",
                'clear_button': "Clear",
                'result_title': "Generated letter",
                'copy_success': "Letter copied to clipboard!",
                'export_word': "Export to Word",
                'export_pdf': "Export to PDF",
                'new_template': "New template",
                'template_name': "Template name",
                'template_category': "Category",
                'template_tags': "Tags (comma separated)",
                'template_content': "Content",
                'save': "Save",
                'cancel': "Cancel",
                'delete_confirm': "Do you really want to delete this template?"
            }
        };

        // Fonction pour changer la langue
        function changeLanguage(lang) {
            // Mettre à jour tous les éléments avec data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    if (element.tagName === 'INPUT') {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            // Mettre à jour les attributs aria-label
            document.querySelectorAll('[aria-label]').forEach(element => {
                const key = element.getAttribute('data-i18n-aria');
                if (key && translations[lang][key]) {
                    element.setAttribute('aria-label', translations[lang][key]);
                }
            });

            // Sauvegarder la préférence de langue
            localStorage.setItem('preferredLanguage', lang);

            // Mettre à jour la langue pour la validation
            updateValidationMessages(lang);
        }

        // Charger la langue préférée au démarrage
        document.addEventListener('DOMContentLoaded', () => {
            const preferredLanguage = localStorage.getItem('preferredLanguage') || 'fr';
            document.getElementById('languageSelect').value = preferredLanguage;
            changeLanguage(preferredLanguage);
        });

        // Mettre à jour les messages de validation
        function updateValidationMessages(lang) {
            const messages = translations[lang];
            // Mettre à jour les messages d'erreur personnalisés
            const inputs = document.querySelectorAll('input[data-validate]');
            inputs.forEach(input => {
                const validationType = input.getAttribute('data-validate');
                if (validationType === 'required') {
                    input.setCustomValidity(messages[`${input.id}_required`] || '');
                }
            });
        }

        document.getElementById('letterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Valider les informations
            if (!validateAndUpdateInfo()) {
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            
            const data = {
                company: document.getElementById('company').value,
                position: document.getElementById('position').value,
                duration: document.getElementById('duration').value,
                start_date: document.getElementById('start_date').value,
                custom_paragraph: document.getElementById('custom_paragraph').value,
                template: document.getElementById('letter_template').value
            };
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                document.getElementById('letterContent').textContent = result.content;
                document.getElementById('resultSection').style.display = 'block';
            } catch (error) {
                alert('Erreur lors de la génération de la lettre');
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        async function exportLetter(type) {
            try {
                const content = document.getElementById('letterContent').innerHTML;
                
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        format: type
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `lettre_motivation.${type}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Erreur lors de l\'export');
                }
            } catch (error) {
                alert('Erreur lors de l\'export : ' + error.message);
            }
        }

        // Charger les templates au démarrage
        async function loadTemplates() {
            try {
                const response = await fetch('/templates');
                const templates = await response.json();
                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">Sélectionner un modèle...</option>';
                
                for (const [name, content] of Object.entries(templates)) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des templates:', error);
            }
        }

        // Gestionnaire de changement de template
        document.getElementById('templateSelect').addEventListener('change', function() {
            const content = templates[this.value];
            if (content) {
                document.getElementById('custom_paragraph').value = content;
            }
        });

        // Ajouter un nouveau template
        async function addTemplate() {
            const name = prompt('Nom du nouveau modèle :');
            if (!name) return;
            
            const content = document.getElementById('custom_paragraph').value;
            
            try {
                const response = await fetch('/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        name: name,
                        content: content
                    })
                });
                
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    loadTemplates();
                }
            } catch (error) {
                console.error('Erreur lors de l\'ajout du template:', error);
                alert('Erreur lors de l\'ajout du template');
            }
        }

        // Modifier un template existant
        async function editTemplate() {
            const select = document.getElementById('templateSelect');
            const name = select.value;
            if (!name) {
                alert('Veuillez sélectionner un template à modifier');
                return;
            }
            
            const content = document.getElementById('custom_paragraph').value;
            
            try {
                const response = await fetch('/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'edit',
                        name: name,
                        content: content
                    })
                });
                
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                console.error('Erreur lors de la modification du template:', error);
                alert('Erreur lors de la modification du template');
            }
        }

        // Supprimer un template
        async function deleteTemplate() {
            const select = document.getElementById('templateSelect');
            const name = select.value;
            if (!name) {
                alert('Veuillez sélectionner un template à supprimer');
                return;
            }
            
            if (!confirm(`Êtes-vous sûr de vouloir supprimer le template "${name}" ?`)) {
                return;
            }
            
            try {
                const response = await fetch('/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        name: name
                    })
                });
                
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    loadTemplates();
                    document.getElementById('custom_paragraph').value = '';
                }
            } catch (error) {
                console.error('Erreur lors de la suppression du template:', error);
                alert('Erreur lors de la suppression du template');
            }
        }

        // Fonctions de mise en forme
        function formatText(style) {
            const textarea = document.getElementById('custom_paragraph');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            let prefix = '';
            let suffix = '';
            
            switch (style) {
                case 'bold':
                    prefix = '**';
                    suffix = '**';
                    break;
                case 'italic':
                    prefix = '_';
                    suffix = '_';
                    break;
                case 'underline':
                    prefix = '__';
                    suffix = '__';
                    break;
            }
            
            textarea.value = text.substring(0, start) + prefix + text.substring(start, end) + suffix + text.substring(end);
            textarea.setSelectionRange(start + prefix.length, end + prefix.length);
            textarea.focus();
        }

        function alignText(alignment) {
            const buttons = document.querySelectorAll('.btn-format[onclick^="alignText"]');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const textarea = document.getElementById('custom_paragraph');
            textarea.style.textAlign = alignment;
        }

        function setLineSpacing(spacing) {
            const textarea = document.getElementById('custom_paragraph');
            textarea.style.lineHeight = spacing;
        }

        // Insérer un marqueur à la position du curseur
        function insertMarker(type) {
            const textarea = document.getElementById('letter_template');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const marker = `[[${type}]]`;
            
            textarea.value = text.substring(0, start) + marker + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + marker.length, start + marker.length);
            
            highlightMarkers();
        }

        // Mettre en surbrillance les marqueurs
        function highlightMarkers() {
            const textarea = document.getElementById('letter_template');
            const text = textarea.value;
            const markerColors = {
                'company': '#34C759',
                'position': '#3498DB',
                'duration': '#9B59B6',
                'start_date': '#F7DC6F',
                'today_date': '#FFC5C5',
                'custom': '#FFA07A'
            };
            
            let highlightedText = text;
            for (const [type, color] of Object.entries(markerColors)) {
                const regex = new RegExp(`\\[\\[${type}\\]\\]`, 'g');
                highlightedText = highlightedText.replace(regex, `<span class="marked-text marked-${type}">[[${type}]]</span>`);
            }
            
            // Mettre à jour la prévisualisation
            const preview = document.getElementById('letterContent');
            if (preview) {
                preview.innerHTML = highlightedText;
            }
        }

        // Écouter les changements dans le template
        document.getElementById('letter_template').addEventListener('input', highlightMarkers);
        
        // Charger les templates au démarrage
        loadTemplates();
        
        // Fonction pour valider et mettre à jour les informations
        function validateAndUpdateInfo() {
            const fields = {
                'company': 'Entreprise',
                'position': 'Poste',
                'duration': 'Type de contrat',
                'start_date': 'Date de début',
                'custom_paragraph': 'Paragraphe personnalisé'
            };
            
            const errors = [];
            const values = {};
            
            // Vérifier chaque champ
            for (const [id, label] of Object.entries(fields)) {
                const value = document.getElementById(id).value.trim();
                values[id] = value;
                
                // Mettre à jour le résumé
                const summaryElement = document.getElementById(`summary-${id}`);
                if (value) {
                    summaryElement.textContent = value;
                    summaryElement.classList.remove('empty');
                } else {
                    summaryElement.textContent = 'Non renseigné';
                    summaryElement.classList.add('empty');
                    errors.push(`Le champ "${label}" est requis`);
                }
            }
            
            // Afficher les erreurs s'il y en a
            const errorContainer = document.getElementById('validation-errors');
            if (errorContainer) {
                errorContainer.innerHTML = '';
                if (errors.length > 0) {
                    errors.forEach(error => {
                        const div = document.createElement('div');
                        div.className = 'validation-error';
                        div.textContent = error;
                        errorContainer.appendChild(div);
                    });
                    return false;
                }
            }
            
            // Mettre à jour le nom du fichier
            const filename = document.getElementById('filename');
            if (filename) {
                filename.value = `lettre_motivation_${values.company.toLowerCase().replace(/\s+/g, '_')}.docx`;
            }
            
            return true;
        }

        // Écouter les changements dans les champs
        const fields = ['company', 'position', 'duration', 'start_date', 'custom_paragraph'];
        fields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                element.addEventListener('input', validateAndUpdateInfo);
                element.addEventListener('change', validateAndUpdateInfo);
            }
        });

        // Gestion du thème
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // Charger le thème sauvegardé
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }
        
        // Gestion du formatage du texte
        function formatText(style) {
            const textarea = document.getElementById('letter_template');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            if (start === end) return;
            
            const selectedText = text.substring(start, end);
            const button = event.target;
            
            // Vérifier si le style est déjà appliqué
            const isStyled = button.classList.contains('active');
            button.classList.toggle('active');
            
            // Appliquer ou retirer le style
            const formattedText = isStyled ? selectedText : `<${style}>${selectedText}</${style}>`;
            
            textarea.value = text.substring(0, start) + formattedText + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + formattedText.length);
        }
        
        // Gestion de l'alignement
        function alignText(alignment) {
            const textarea = document.getElementById('letter_template');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            if (start === end) return;
            
            const selectedText = text.substring(start, end);
            const alignedText = `<align="${alignment}">${selectedText}</align>`;
            
            textarea.value = text.substring(0, start) + alignedText + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + alignedText.length);
            
            // Mettre à jour les boutons
            document.querySelectorAll('.btn-toolbar[onclick^="alignText"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Gestion de l'interligne
        function setLineSpacing(spacing) {
            const textarea = document.getElementById('letter_template');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            if (start === end) return;
            
            const selectedText = text.substring(start, end);
            const spacedText = `<spacing="${spacing}">${selectedText}</spacing>`;
            
            textarea.value = text.substring(0, start) + spacedText + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + spacedText.length);
        }
        
        // Sauvegarder automatiquement
        function autoSave() {
            const data = {
                company: document.getElementById('company').value,
                position: document.getElementById('position').value,
                duration: document.getElementById('duration').value,
                start_date: document.getElementById('start_date').value,
                custom_paragraph: document.getElementById('custom_paragraph').value,
                template: document.getElementById('letter_template').value
            };
            
            localStorage.setItem('letterData', JSON.stringify(data));
        }
        
        // Charger les données sauvegardées
        function loadSavedData() {
            const savedData = localStorage.getItem('letterData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                for (const [key, value] of Object.entries(data)) {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                    }
                }
                
                validateAndUpdateInfo();
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadSavedData();
            
            // Configurer la sauvegarde automatique
            const fields = ['company', 'position', 'duration', 'start_date', 'custom_paragraph', 'letter_template'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.addEventListener('input', autoSave);
                    element.addEventListener('change', autoSave);
                }
            });
        });

        // Copier dans le presse-papiers
        function copyToClipboard() {
            const content = document.getElementById('letterContent');
            
            // Créer un élément temporaire
            const temp = document.createElement('textarea');
            temp.value = content.textContent;
            document.body.appendChild(temp);
            
            // Sélectionner et copier
            temp.select();
            document.execCommand('copy');
            
            // Nettoyer
            document.body.removeChild(temp);
            
            // Afficher une notification
            alert('Lettre copiée dans le presse-papiers !');
        }

        // Validation côté client
        function validateForm() {
            const company = document.getElementById('company').value;
            const position = document.getElementById('position').value;
            
            let errors = [];
            
            // Valider les champs requis
            if (!company.trim()) {
                errors.push("Le champ 'Entreprise' est requis");
            }
            if (!position.trim()) {
                errors.push("Le champ 'Poste' est requis");
            }
            
            // Valider le format des dates
            const dateRegex = /^(\d{2}\/\d{2}\/\d{4}|\d{4}-\d{2}-\d{2}|\d{2}-\d{2}-\d{4}|\d{2}\.\d{2}\.\d{4})$/;
            
            const startDate = document.getElementById('start_date').value;
            if (startDate && !dateRegex.test(startDate)) {
                errors.push("Format de date invalide pour 'Date de début'. Utilisez JJ/MM/AAAA");
            }
            
            const todayDate = document.getElementById('today_date').value;
            if (todayDate && !dateRegex.test(todayDate)) {
                errors.push("Format de date invalide pour 'Date du jour'. Utilisez JJ/MM/AAAA");
            }
            
            // Valider la durée
            const duration = document.getElementById('duration').value;
            if (duration) {
                const durationRegex = /^(\d+)\s*(mois|ans?|semaines?)$/;
                if (!durationRegex.test(duration.toLowerCase())) {
                    errors.push("Format de durée invalide. Exemple: '6 mois', '2 ans', '3 semaines'");
                }
            }
            
            // Afficher les erreurs
            if (errors.length > 0) {
                alert(errors.join("\n"));
                return false;
            }
            
            return true;
        }
        
        // Raccourcis clavier
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S pour générer
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (validateForm()) {
                    generateLetter();
                }
            }
            
            // Ctrl/Cmd + E pour exporter
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                const letterContent = document.getElementById('letterContent');
                if (letterContent.innerHTML) {
                    exportLetter('docx');
                }
            }
            
            // Ctrl/Cmd + P pour exporter en PDF
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                const letterContent = document.getElementById('letterContent');
                if (letterContent.innerHTML) {
                    exportLetter('pdf');
                }
            }
            
            // Ctrl/Cmd + N pour nouveau modèle
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showNewTemplateModal();
            }
            
            // Échap pour fermer les modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
            }
        });
        
        // Validation en temps réel
        document.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', function() {
                // Supprimer la classe d'erreur
                this.classList.remove('is-invalid');
                
                // Valider selon le type de champ
                if (this.dataset.validate === 'required' && !this.value.trim()) {
                    this.classList.add('is-invalid');
                }
                else if (this.dataset.validate === 'date' && this.value) {
                    const dateRegex = /^(\d{2}\/\d{2}\/\d{4}|\d{4}-\d{2}-\d{2}|\d{2}-\d{2}-\d{4}|\d{2}\.\d{2}\.\d{4})$/;
                    if (!dateRegex.test(this.value)) {
                        this.classList.add('is-invalid');
                    }
                }
                else if (this.dataset.validate === 'duration' && this.value) {
                    const durationRegex = /^(\d+)\s*(mois|ans?|semaines?)$/;
                    if (!durationRegex.test(this.value.toLowerCase())) {
                        this.classList.add('is-invalid');
                    }
                }
            });
        });
        
        // Initialisation des tooltips pour les raccourcis clavier
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Fonction de prévisualisation
        async function previewLetter() {
            try {
                // Récupérer toutes les données du formulaire
                const data = {
                    full_name: document.getElementById('full_name').value,
                    address: document.getElementById('address').value,
                    postal_code: document.getElementById('postal_code').value,
                    city: document.getElementById('city').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    company: document.getElementById('company').value,
                    company_address: document.getElementById('company_address').value,
                    company_postal_code: document.getElementById('company_postal_code').value,
                    company_city: document.getElementById('company_city').value,
                    subject: document.getElementById('subject').value,
                    content: document.getElementById('letterContent').value,
                    date: new Date().toLocaleDateString('fr-FR')
                };
                
                // Appeler l'API de prévisualisation
                const response = await fetch('/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Injecter le CSS
                    let styleElement = document.getElementById('previewStyles');
                    if (!styleElement) {
                        styleElement = document.createElement('style');
                        styleElement.id = 'previewStyles';
                        document.head.appendChild(styleElement);
                    }
                    styleElement.textContent = result.css;
                    
                    // Injecter le HTML
                    document.getElementById('previewContent').innerHTML = result.html;
                    
                    // Afficher la modal
                    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                    previewModal.show();
                } else {
                    showError(result.error || 'Erreur lors de la prévisualisation');
                }
                
            } catch (error) {
                showError('Erreur lors de la prévisualisation : ' + error.message);
            }
        }
        
        // Fonction d'export
        async function exportLetter(format) {
            try {
                // Récupérer toutes les données du formulaire
                const data = {
                    full_name: document.getElementById('full_name').value,
                    address: document.getElementById('address').value,
                    postal_code: document.getElementById('postal_code').value,
                    city: document.getElementById('city').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    company: document.getElementById('company').value,
                    company_address: document.getElementById('company_address').value,
                    company_postal_code: document.getElementById('company_postal_code').value,
                    company_city: document.getElementById('company_city').value,
                    subject: document.getElementById('subject').value,
                    content: document.getElementById('letterContent').value,
                    date: new Date().toLocaleDateString('fr-FR'),
                    format: format
                };
                
                // Appeler l'API d'export
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de l\'export');
                }
                
                // Télécharger le fichier
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lettre_motivation_${format === 'docx' ? 'word' : 'pdf'}_${new Date().toISOString().slice(0,10)}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess(`Export en ${format.toUpperCase()} réussi !`);
                
            } catch (error) {
                showError('Erreur lors de l\'export : ' + error.message);
            }
        }
        
        // Fonction pour afficher une erreur
        function showError(message) {
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            document.getElementById('errorToastBody').textContent = message;
            toast.show();
        }
        
        // Fonction pour afficher un succès
        function showSuccess(message) {
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            document.getElementById('successToastBody').textContent = message;
            toast.show();
        }
    </script>

    <!-- Toasts pour les notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Erreur</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorToastBody"></div>
        </div>
        
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Succès</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="successToastBody"></div>
        </div>
    </div>
</body>
</html>
